<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taleforge - Confirmation</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #0D0D0D;
        color: #FFFFFF;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .container { max-width: 400px; width: 100%; text-align: center; }
    .icon { font-size: 64px; margin-bottom: 20px; }
    h1 { color: #E8D5B7; margin-bottom: 12px; font-size: 28px; }
    p { color: #8E8E93; margin-bottom: 24px; line-height: 1.5; }
    .form-group { margin-bottom: 16px; text-align: left; }
    label { display: block; color: #C4A574; margin-bottom: 8px; font-size: 14px; }
    input {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid #2C2C2E;
        background: #1C1C1E;
        color: #FFFFFF;
        font-size: 16px;
    }
    input:focus { outline: none; border-color: #C4A574; }
    .btn {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        border: none;
        background: #C4A574;
        color: #0D0D0D;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .error { color: #FF6B6B; margin-top: 16px; }
    .success { color: #30D158; }
    .hint { font-size: 13px; color: #6E6E73; margin-top: 8px; }
</style>
</head>
<body>
<div class="container" id="content">
    <div class="icon">‚è≥</div>
    <h1>Loading...</h1>
    <p>Please wait while we verify your request.</p>
</div>

<script>
const SUPABASE_URL = 'https://jtohceewkvaoukihalkl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0b2hjZWV3a3Zhb3VraWhhbGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MjQwODgsImV4cCI6MjA4MjEwMDA4OH0.zBjeX8ZpFqY05DmU1x42i4U5zMpA8eVDFqxSj4JBk80';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const container = document.getElementById('content');

function parseHash() {
    const hash = window.location.hash.substring(1);
    if (!hash) return {};
    return Object.fromEntries(new URLSearchParams(hash));
}

async function init() {
    const { type, access_token: accessToken, refresh_token: refreshToken } = parseHash();

    try {
        if (type === 'recovery' && accessToken) {
            showPasswordResetForm(accessToken, refreshToken);
        } else if (type === 'signup' || type === 'email_change' || type === 'magiclink') {
            showEmailConfirmed();
        } else if (accessToken) {
            showEmailConfirmed();
        } else {
            showDefaultMessage();
        }
    } catch (err) {
        console.error(err);
        showDefaultMessage();
    }
}

function showDefaultMessage() {
    container.innerHTML = `
        <div class="icon">‚ÑπÔ∏è</div>
        <h1>Welcome!</h1>
        <p>No action required. You can return to the app or try accessing the confirmation link again.</p>
    `;
}

function showEmailConfirmed() {
    container.innerHTML = `
        <div class="icon">‚úì</div>
        <h1>Email Confirmed!</h1>
        <p>Your email has been verified successfully.<br>You can now return to the app and sign in.</p>
    `;
}

function showPasswordResetForm(accessToken, refreshToken) {
    container.innerHTML = `
        <div class="icon">üîê</div>
        <h1>Reset Your Password</h1>
        <p>Enter your new password below.</p>
        <form id="resetForm">
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password" required minlength="6">
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password" required minlength="6">
            </div>
            <p class="hint">Password must be at least 6 characters</p>
            <button type="submit" class="btn" id="submitBtn">Reset Password</button>
        </form>
        <p id="message"></p>
    `;

    document.getElementById('resetForm').addEventListener('submit', e => handlePasswordReset(e, accessToken, refreshToken));
}

async function handlePasswordReset(e, accessToken, refreshToken) {
    e.preventDefault();

    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const submitBtn = document.getElementById('submitBtn');
    const message = document.getElementById('message');

    if (newPassword.length < 6) {
        message.className = 'error';
        message.textContent = 'Password must be at least 6 characters';
        return;
    }
    if (newPassword !== confirmPassword) {
        message.className = 'error';
        message.textContent = 'Passwords do not match';
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';
    message.textContent = '';

    try {
        const { error: sessionError } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
        });
        if (sessionError) throw sessionError;

        const { error: updateError } = await supabase.auth.updateUser({ password: newPassword });
        if (updateError) throw updateError;

        showPasswordResetSuccess();
    } catch (err) {
        console.error(err);
        message.className = 'error';
        message.textContent = err.message || 'Failed to reset password. Please try again.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Reset Password';
    }
}

function showPasswordResetSuccess() {
    container.innerHTML = `
        <div class="icon success">‚úì</div>
        <h1 class="success">Password Reset!</h1>
        <p>Your password has been successfully updated.<br>You can now return to the app and sign in with your new password.</p>
    `;
}

init();
</script>
</body>
</html>
